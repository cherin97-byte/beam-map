<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¸µë³„ ë„ë©´ - ë¶€ì¬ ìœ„ì¹˜ ë§µ</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .hint {
      position: absolute; z-index: 9999; left: 10px; top: 10px;
      background: rgba(255,255,255,0.92); padding: 8px 10px; border-radius: 8px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-size: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      line-height: 1.25;
      max-width: calc(100vw - 40px);
    }

    .searchbox{
      position:absolute; z-index:9999; left:10px; top:70px;
      display:flex; gap:6px; align-items:center;
      background: rgba(255,255,255,0.92); padding:8px 10px; border-radius:8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      max-width: calc(100vw - 40px);
      flex-wrap: wrap;
    }
    .searchbox input{
      width: 180px; padding: 6px 8px; border:1px solid #ccc; border-radius:6px;
      outline: none;
    }
    .searchbox button{
      padding: 6px 10px; border:1px solid #ccc; border-radius:6px; background:#fff;
      cursor:pointer;
    }

    .floorbar{
      position:absolute; z-index:9999; left:10px; top:128px;
      display:flex; flex-wrap:wrap; gap:6px;
      background: rgba(255,255,255,0.92); padding:8px 10px; border-radius:8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      max-width: calc(100vw - 40px);
    }
    .floorbar button{
      padding: 6px 10px; border:1px solid #ccc; border-radius:999px; background:#fff; cursor:pointer;
      white-space: nowrap;
    }
    .floorbar button.active{
      border-color:#333;
      font-weight:600;
    }

    .legend{
      position:absolute; z-index:9999; left:10px; bottom:10px;
      background: rgba(255,255,255,0.92); padding:8px 10px; border-radius:8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-size: 13px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      max-width: calc(100vw - 40px);
    }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
    .dot.done { background:#16a34a; } /* ì´ˆë¡ */
    .dot.todo { background:#dc2626; } /* ë¹¨ê°• */

    @media (max-width: 480px){
      .searchbox input{ width: 140px; }
      .hint{ font-size: 13px; }
    }
  </style>
</head>

<body>
  <div class="hint">
    ğŸ“Œ ë„ë©´ ë“œë˜ê·¸/í™•ëŒ€ ê°€ëŠ¥<br/>
    ğŸ” ë¶€ì¬ë²ˆí˜¸ ê²€ìƒ‰ (ì˜ˆ: B12) â†’ ìœ„ì¹˜ë¡œ ì´ë™<br/>
    ğŸ”„ ì‹œíŠ¸ ê°±ì‹  ë²„íŠ¼ìœ¼ë¡œ ì¢Œí‘œ/ìƒíƒœ ìµœì‹  ë°˜ì˜<br/>
    (ë””ë²„ê·¸) ë„ë©´ í´ë¦­ ì‹œ ì¢Œí‘œê°€ ì½˜ì†”ì— ì¶œë ¥ë©ë‹ˆë‹¤.
  </div>

  <!-- ê²€ìƒ‰ + ê°±ì‹  UI -->
  <div class="searchbox">
    <input id="beamSearch" type="text" placeholder="ë¶€ì¬ë²ˆí˜¸ ê²€ìƒ‰ (ì˜ˆ: B12)" />
    <button id="beamSearchBtn">ì°¾ê¸°</button>
    <button id="beamClearBtn">ì´ˆê¸°í™”</button>
    <button id="refreshBtn" title="êµ¬ê¸€ì‹œíŠ¸ ë‹¤ì‹œ ì½ê¸°">ì‹œíŠ¸ê°±ì‹ </button>
  </div>

  <!-- ì¸µ/ë™ ì„ íƒ UI (í‘œì‹œëª…ì€ ì›í•˜ëŠ” ëŒ€ë¡œ) -->
  <div class="floorbar">
    <button data-plan="B1F_A">B1F-Aë™</button>
    <button data-plan="B1F_B">B1F-Bë™</button>
    <button data-plan="1F_A">1F-Aë™</button>
    <button data-plan="1F_B">1F-Bë™</button>
  </div>

  <div class="legend">
    <span><span class="dot done"></span>ì¶œí•˜ì™„ë£Œ(Y)</span>
    <span><span class="dot todo"></span>ë¯¸ì¶œí•˜(N)</span>
    <span id="countLabel">-</span>
  </div>

  <div id="map"></div>

  <script>
    window.addEventListener("load", () => {
      // âœ… ì‚¬ìš©ì ì œê³µ CSV URL
      const CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vTIVHYKFpIvq87dpVFvo_81ExKssGZ4oXdcc4pxAliO7DWs4RUYd-i3RVNtrjLZA-6IlUiimktgxR_I/pub?gid=0&single=true&output=csv";

      // ì§€ë„(ë„ë©´) ì´ˆê¸°í™”
      const map = L.map("map", {
        crs: L.CRS.Simple,
        minZoom: -2,
        maxZoom: 2,
        zoomSnap: 0.25,
        zoomDelta: 0.25
      });

      // ë„ë©´ ì˜¤ë²„ë ˆì´/ë§ˆì»¤ ë ˆì´ì–´ë¥¼ êµì²´ ê°€ëŠ¥í•˜ê²Œ ê´€ë¦¬
      let overlay = null;
      const markerLayer = L.layerGroup().addTo(map);
      let markerById = new Map();     // í˜„ì¬ planì˜ id -> marker
      let bounds = null;
      let currentPlanKey = "B1F_A";

      /**
       * âœ… í”Œëœ(ì¸µ-ë™) ì •ì˜
       * - imageUrl: GitHubì— ì˜¬ë¦° ë„ë©´ ì´ë¯¸ì§€ íŒŒì¼ëª… (ì €ì¥ì†Œ rootì— ìˆì–´ì•¼ í•¨)
       * - width/height: í•´ë‹¹ ì´ë¯¸ì§€ ì‹¤ì œ í”½ì…€ í¬ê¸°
       * - beams: êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ë¡œë“œë˜ì–´ ìë™ ì±„ì›€
       *
       * âš ï¸ ì•„ë˜ imageUrl/width/heightëŠ” ë°˜ë“œì‹œ ì‹¤ì œ íŒŒì¼/í¬ê¸°ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.
       */
      const PLANS = {
        "B1F_A": { imageUrl: "B1F_A.png", width: 2000, height: 1200, beams: [] },
        "B1F_B": { imageUrl: "B1F_B.png", width: 2000, height: 1200, beams: [] },
        "1F_A":  { imageUrl: "1F_A.png",  width: 2000, height: 1200, beams: [] },
        "1F_B":  { imageUrl: "1F_B.png",  width: 2000, height: 1200, beams: [] },
      };

      // ---------------------------
      // CSV íŒŒì„œ(ë”°ì˜´í‘œ í¬í•¨ ê¸°ë³¸ ëŒ€ì‘)
      // ---------------------------
      function parseCSVLine(line) {
        const out = [];
        let cur = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            // "" -> "
            if (inQuotes && line[i + 1] === '"') {
              cur += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (ch === "," && !inQuotes) {
            out.push(cur);
            cur = "";
          } else {
            cur += ch;
          }
        }
        out.push(cur);
        return out.map(s => s.trim());
      }

      function parseCSV(text) {
        const lines = text.replace(/\r/g, "").split("\n").filter(l => l.trim().length > 0);
        if (lines.length < 2) return [];

        const header = parseCSVLine(lines[0]).map(h => h.toLowerCase());
        const idx = (name) => header.indexOf(name);

        const iPlan = idx("plan");
        const iId = idx("id");
        const iX = idx("x");
        const iY = idx("y");
        const iStatus = idx("status");

        if ([iPlan, iId, iX, iY, iStatus].some(v => v < 0)) {
          throw new Error("CSV í—¤ë”ê°€ plan,id,x,y,status ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.");
        }

        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = parseCSVLine(lines[i]);
          const plan = cols[iPlan] || "";
          const id = cols[iId] || "";
          const x = Number(cols[iX]);
          const y = Number(cols[iY]);
          const status = (cols[iStatus] || "").trim();

          if (!plan || !id || Number.isNaN(x) || Number.isNaN(y)) continue;

          rows.push({ plan, id, x, y, status });
        }
        return rows;
      }

      function normalizePlanKey(planRaw) {
        // ì‹œíŠ¸ plan ê°’ì€ ë²„íŠ¼ data-planê³¼ ë™ì¼í•˜ê²Œ: B1F_A, 1F_B í˜•íƒœë¥¼ ê¶Œì¥
        return String(planRaw || "").trim();
      }

      function isDoneStatus(statusRaw) {
        const s = String(statusRaw || "").trim().toUpperCase();
        // Y / YES / TRUE / 1 / ì¶œí•˜ì™„ë£Œ ë„ í—ˆìš©
        return (s === "Y" || s === "YES" || s === "TRUE" || s === "1" || s.includes("ì¶œí•˜"));
      }

      async function loadBeamsFromSheet() {
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("CSV ë¡œë“œ ì‹¤íŒ¨: HTTP " + res.status);
        const text = await res.text();
        const rows = parseCSV(text);

        // planë³„ beams ì´ˆê¸°í™”
        Object.keys(PLANS).forEach(k => PLANS[k].beams = []);

        // rows -> PLANS[plan].beams
        rows.forEach(r => {
          const planKey = normalizePlanKey(r.plan);
          if (!PLANS[planKey]) return; // ì •ì˜ë˜ì§€ ì•Šì€ planì€ ë¬´ì‹œ

          PLANS[planKey].beams.push({
            id: r.id,
            x: r.x,
            y: r.y,
            done: isDoneStatus(r.status)
          });
        });
      }

      // ---------------------------
      // ì§€ë„ í‘œì‹œ ë¡œì§
      // ---------------------------
      function setActivePlanButton(planKey) {
        document.querySelectorAll(".floorbar button").forEach(btn => {
          btn.classList.toggle("active", btn.dataset.plan === planKey);
        });
      }

      function updateCountLabel(planKey) {
        const beams = (PLANS[planKey] && PLANS[planKey].beams) ? PLANS[planKey].beams : [];
        const total = beams.length;
        const done = beams.filter(b => b.done).length;
        const pct = total ? Math.round((done / total) * 100) : 0;
        document.getElementById("countLabel").textContent =
          `ì´ ${total} / ì¶œí•˜ì™„ë£Œ ${done} (${pct}%)`;
      }

      function loadPlan(planKey) {
        const p = PLANS[planKey];
        if (!p) {
          alert("í”Œëœ ì •ì˜ê°€ ì—†ìŠµë‹ˆë‹¤: " + planKey);
          return;
        }
        currentPlanKey = planKey;

        // 1) ë„ë©´ êµì²´
        if (overlay) map.removeLayer(overlay);
        bounds = [[0, 0], [p.height, p.width]];
        overlay = L.imageOverlay(p.imageUrl, bounds).addTo(map);
        map.fitBounds(bounds);

        // 2) ë§ˆì»¤ êµì²´
        markerLayer.clearLayers();
        markerById = new Map();

        (p.beams || []).forEach(b => {
          const color = b.done ? "#16a34a" : "#dc2626"; // ì´ˆë¡/ë¹¨ê°•
          const marker = L.circleMarker([b.y, b.x], {
            radius: 7,
            color: color,
            fillColor: color,
            fillOpacity: 0.85,
            weight: 2
          }).addTo(markerLayer);

          marker.bindPopup(
            `<b>ë¶€ì¬ë²ˆí˜¸:</b> ${escapeHtml(b.id)}<br/>` +
            `<b>ì¶œí•˜ìƒíƒœ:</b> ${b.done ? "ì¶œí•˜ì™„ë£Œ" : "ë¯¸ì¶œí•˜"}<br/>` +
            `<small>ì¢Œí‘œ: (${b.x}, ${b.y})</small>`
          );

          markerById.set(String(b.id).trim().toUpperCase(), marker);
        });

        setActivePlanButton(planKey);
        updateCountLabel(planKey);
      }

      function focusBeam(idRaw) {
        const id = String(idRaw || "").trim().toUpperCase();
        if (!id) return;

        const marker = markerById.get(id);
        if (!marker) {
          alert(`í˜„ì¬ ì„ íƒí•œ í™”ë©´(${currentPlanKey})ì—ì„œ '${id}' ë¶€ì¬ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
          return;
        }
        const latlng = marker.getLatLng();
        map.setView(latlng, 0.8, { animate: true }); // ì¤Œê°’ì€ 0.5~1.5ì—ì„œ ì¡°ì •
        marker.openPopup();
      }

      // XSS ë°©ì§€ìš©(íŒì—…ì— ë¶€ì¬ë²ˆí˜¸ ë„£ì„ ë•Œ)
      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, (m) => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
        }[m]));
      }

      // ---------------------------
      // UI ì´ë²¤íŠ¸
      // ---------------------------
      document.querySelectorAll(".floorbar button").forEach(btn => {
        btn.addEventListener("click", () => loadPlan(btn.dataset.plan));
      });

      document.getElementById("beamSearchBtn").addEventListener("click", () => {
        focusBeam(document.getElementById("beamSearch").value);
      });
      document.getElementById("beamSearch").addEventListener("keydown", (e) => {
        if (e.key === "Enter") focusBeam(e.target.value);
      });
      document.getElementById("beamClearBtn").addEventListener("click", () => {
        document.getElementById("beamSearch").value = "";
        if (bounds) map.fitBounds(bounds);
      });

      document.getElementById("refreshBtn").addEventListener("click", async () => {
        try {
          document.getElementById("refreshBtn").textContent = "ê°±ì‹ ì¤‘...";
          document.getElementById("refreshBtn").disabled = true;

          await loadBeamsFromSheet();
          loadPlan(currentPlanKey); // í˜„ì¬ í™”ë©´ ìœ ì§€í•œ ì±„ë¡œ ë‹¤ì‹œ ê·¸ë¦¼
        } catch (err) {
          console.error(err);
          alert("ì‹œíŠ¸ ê°±ì‹  ì‹¤íŒ¨: " + err.message);
        } finally {
          document.getElementById("refreshBtn").textContent = "ì‹œíŠ¸ê°±ì‹ ";
          document.getElementById("refreshBtn").disabled = false;
        }
      });

      // (ë””ë²„ê·¸) ë„ë©´ í´ë¦­ ì‹œ ì¢Œí‘œ ì¶œë ¥: í•€ ì¢Œí‘œ ë”°ê¸°ìš©
      map.on("click", (e) => {
        const x = Math.round(e.latlng.lng);
        const y = Math.round(e.latlng.lat);
        console.log("CLICK XY =", { x, y, plan: currentPlanKey });
      });

      // ---------------------------
      // ìµœì´ˆ ë¡œë”©: ì‹œíŠ¸ ì½ê³  -> ê¸°ë³¸ í”Œëœ í‘œì‹œ
      // ---------------------------
      (async () => {
        try {
          await loadBeamsFromSheet();
        } catch (err) {
          console.error(err);
          alert("êµ¬ê¸€ì‹œíŠ¸ ì—°ë™ ì‹¤íŒ¨(ë„ë©´ì€ í‘œì‹œë˜ì§€ë§Œ í•€ì€ ì—†ì„ ìˆ˜ ìˆìŒ): " + err.message);
        } finally {
          loadPlan(currentPlanKey);
        }
      })();
    });
  </script>
</body>
</html>
